# Docker Compose for Licensed IRIS with ACORN=1 HNSW Optimization
# FHIR AI Hackathon Kit - Enterprise Edition (x86/AMD64)
# For AWS deployment on x86 instances (EC2, ECS, etc.)
#
# IRIS Enterprise Features:
# - ACORN=1 HNSW optimization for vector search
# - Enhanced ML capabilities
# - Production-ready performance
#
# Architecture: x86/AMD64 (for AWS, most cloud providers)
# License: iris.x64.key (Ubuntu-x64)

services:
  iris-fhir-licensed:
    image: intersystemsdc/iris-community:2025.3.0EHAT.127.0  # x86 image (no arm64 suffix)
    container_name: iris-fhir-licensed
    platform: linux/amd64  # Force x86 platform
    ports:
      - "32782:1972"   # IRIS SuperServer port (same as current iris-fhir)
      - "32783:52773"  # IRIS Management Portal (same as current iris-fhir)
    environment:
      - IRISNAMESPACE=DEMO         # FHIR data namespace
      - ISC_DEFAULT_PASSWORD=ISCDEMO  # Match current FHIR setup
    volumes:
      - iris-fhir-licensed-data:/usr/irissys/mgr  # Named volume for persistence
      - .:/home/irisowner/dev  # Mount project directory
      - ./iris.x64.key:/usr/irissys/mgr/iris.key  # x86 Enterprise license key
    stdin_open: true
    tty: true
    healthcheck:
      test: ["CMD", "/usr/irissys/bin/iris", "session", "iris", "-U%SYS", "##class(%SYSTEM.Process).CurrentDirectory()"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s
    command: --check-caps false

volumes:
  iris-fhir-licensed-data: {}

# =============================================================================
# USAGE INSTRUCTIONS - AWS x86 DEPLOYMENT
# =============================================================================
#
# 1. USE THIS FILE FOR:
#    - AWS EC2 instances (t3, m5, c5, g4dn, etc.)
#    - AWS ECS/Fargate (x86)
#    - Most cloud providers (GCP, Azure)
#    - Local x86 Linux machines
#
# 2. ARCHITECTURE DIFFERENCES:
#    ARM64 (Mac):       docker-compose.licensed.yml + iris.key
#    x86 (AWS):         docker-compose.licensed.x64.yml + iris.x64.key
#
# 3. START ON AWS:
#    docker-compose -f docker-compose.licensed.x64.yml up -d
#
# 4. VERIFY LICENSE:
#    docker exec iris-fhir-licensed iris session iris -U%SYS "##class(%SYSTEM.License).DisplayActivated()"
#
# 5. EXPECTED PERFORMANCE (AWS g5.xlarge):
#    - Text vector search (3072-dim, 200K docs): <30ms
#    - Image vector search (1024-dim, 944 images): <5ms
#    - Cross-modal search: <50ms
#    - Multi-modal fusion: <100ms
#    - Throughput: 2000+ queries/sec
#
# 6. RECOMMENDED AWS INSTANCE TYPES:
#    - g5.xlarge: NVIDIA A10G GPU, 4 vCPU, 16 GB RAM ($1.006/hr)
#    - m5.xlarge: General purpose, 4 vCPU, 16 GB RAM ($0.192/hr)
#    - t3.xlarge: Burstable, 4 vCPU, 16 GB RAM ($0.1664/hr)
#
# Note: iris.x64.key is licensed for "Container(Ubuntu-x64)"
